name: Integration Tests

on:
  workflow_dispatch:
    inputs:
      test_scenario:
        description: 'Test scenario to run'
        required: true
        default: 'basic'
        type: choice
        options:
          - basic
          - with_current_release
          - multiple_products
          - error_handling

jobs:
  integration-test:
    name: Integration Test - ${{ inputs.test_scenario }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Clean Product State Before Test
        run: |
          echo "ðŸ§¹ Cleaning product state before test..."
          
          PRODUCT_UUID="c995fb9c-70cc-4de2-b34f-6ce9d331705a"
          
          # First, clear the current_release_download
          echo "Clearing current release download..."
          curl --fail-with-body --silent --show-error \
            --request PATCH \
            --url "https://api.surecart.com/v1/products/${PRODUCT_UUID}" \
            --header 'Accept: application/json' \
            --header "Authorization: Bearer ${{ secrets.SURECART_API_TOKEN }}" \
            --header 'Content-Type: application/json' \
            --data "{\"product\":{\"id\":\"${PRODUCT_UUID}\",\"current_release_download\":null}}" \
            || echo "Failed to clear current release download (may already be null)"
          
          # Get all downloads for this product
          echo "Fetching existing downloads..."
          DOWNLOADS_RESPONSE=$(curl --fail-with-body --silent \
            --url "https://api.surecart.com/v1/downloads?product=${PRODUCT_UUID}" \
            --header 'Accept: application/json' \
            --header "Authorization: Bearer ${{ secrets.SURECART_API_TOKEN }}")
          
          # Extract download IDs and delete them
          echo "$DOWNLOADS_RESPONSE" | jq -r '.data[]?.id // empty' | while read -r download_id; do
            if [ -n "$download_id" ]; then
              echo "Deleting download: $download_id"
              curl --fail-with-body --silent --show-error \
                --request DELETE \
                --url "https://api.surecart.com/v1/downloads/${download_id}" \
                --header 'Accept: application/json' \
                --header "Authorization: Bearer ${{ secrets.SURECART_API_TOKEN }}" \
                || echo "Failed to delete download: $download_id"
            fi
          done
          
          echo "âœ… Product cleanup completed"

      - name: Test Basic Deployment
        if: inputs.test_scenario == 'basic'
        uses: ./
        with:
          media_uuid: '8cc4a4e0-102b-4266-a81e-4aef9ff5713c'
          product_uuids: 'c995fb9c-70cc-4de2-b34f-6ce9d331705a'
          set_as_current_release: 'false'
          surecart_api_token: ${{ secrets.SURECART_API_TOKEN }}

      - name: Test with Current Release Setting
        if: inputs.test_scenario == 'with_current_release'
        uses: ./
        with:
          media_uuid: '8cc4a4e0-102b-4266-a81e-4aef9ff5713c'
          product_uuids: 'c995fb9c-70cc-4de2-b34f-6ce9d331705a'
          set_as_current_release: 'true'
          surecart_api_token: ${{ secrets.SURECART_API_TOKEN }}

      - name: Test Multiple Products
        if: inputs.test_scenario == 'multiple_products'
        uses: ./
        with:
          media_uuid: '8cc4a4e0-102b-4266-a81e-4aef9ff5713c'
          product_uuids: 'c995fb9c-70cc-4de2-b34f-6ce9d331705a, c995fb9c-70cc-4de2-b34f-6ce9d331705a'
          set_as_current_release: 'false'
          surecart_api_token: ${{ secrets.SURECART_API_TOKEN }}

      - name: Test Error Handling (Invalid Media UUID)
        if: inputs.test_scenario == 'error_handling'
        uses: ./
        id: error-test
        continue-on-error: true
        with:
          media_uuid: 'invalid-uuid-12345'
          product_uuids: 'c995fb9c-70cc-4de2-b34f-6ce9d331705a'
          set_as_current_release: 'false'
          surecart_api_token: ${{ secrets.SURECART_API_TOKEN }}

      - name: Verify Error Test Failed as Expected
        if: inputs.test_scenario == 'error_handling'
        run: |
          if [ "${{ steps.error-test.outcome }}" != "failure" ]; then
            echo "::error::Expected the error test to fail, but it succeeded"
            exit 1
          else
            echo "âœ… Error handling test failed as expected"
          fi

  post-test-cleanup:
    name: Post-Test Information
    runs-on: ubuntu-latest
    needs: integration-test
    if: always()
    steps:
      - name: Integration Test Results
        run: |
          echo "## Integration Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Test Scenario:** ${{ inputs.test_scenario }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ needs.integration-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.integration-test.result }}" == "success" ]; then
            echo "âœ… Integration test passed successfully!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Integration test failed. Check the logs above for details." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** These tests use real API calls to SureCart." >> $GITHUB_STEP_SUMMARY
