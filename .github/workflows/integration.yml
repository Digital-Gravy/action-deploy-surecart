name: Integration Tests

on:
  workflow_dispatch:
    inputs:
      test_scenario:
        description: 'Test scenario to run'
        required: true
        default: 'with_current_release'
        type: choice
        options:
          - with_current_release
          - basic
          - multiple_products
          - error_handling
  push:
    branches: [main]
    paths:
      - 'action.yml'
      - '*.sh'
      - '.github/workflows/integration.yml'
  pull_request:
    branches: [main]
    paths:
      - 'action.yml'
      - '*.sh'
      - '.github/workflows/integration.yml'
  schedule:
    # Run every Monday at 9 AM UTC to catch any external API changes
    - cron: '0 9 * * 1'

jobs:
  integration-test:
    name: Integration Test - ${{ inputs.test_scenario || 'auto' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Clean Product State Before Test
        run: |
          echo "ðŸ§¹ Cleaning product state before test..."
          
          PRODUCT_UUID="c995fb9c-70cc-4de2-b34f-6ce9d331705a"
          TEST_MEDIA_UUID="8cc4a4e0-102b-4266-a81e-4aef9ff5713c"
          
          # Get all downloads for this specific test product using the correct API endpoint
          echo "Fetching downloads for test product ${PRODUCT_UUID}..."
          DOWNLOADS_RESPONSE=$(curl --fail-with-body --silent \
            --url "https://api.surecart.com/v1/downloads?product_ids[]=${PRODUCT_UUID}" \
            --header 'Accept: application/json' \
            --header "Authorization: Bearer ${{ secrets.SURECART_API_TOKEN }}")
          
          echo "Downloads response: $DOWNLOADS_RESPONSE"
          
          # Get all download IDs for this product - we want to delete ALL of them for a clean slate
          ALL_DOWNLOAD_IDS=($(echo "$DOWNLOADS_RESPONSE" | jq -r '.data[]?.id // empty'))
          
          echo "Found ${#ALL_DOWNLOAD_IDS[@]} total downloads in test product to delete"
          
          if [ ${#ALL_DOWNLOAD_IDS[@]} -gt 0 ]; then
            # First, clear the current_release_download on the product to avoid deletion conflicts
            echo "Clearing current release download from product..."
            curl --fail-with-body --silent --show-error \
              --request PATCH \
              --url "https://api.surecart.com/v1/products/${PRODUCT_UUID}" \
              --header 'Accept: application/json' \
              --header "Authorization: Bearer ${{ secrets.SURECART_API_TOKEN }}" \
              --header 'Content-Type: application/json' \
              --data "{\"product\":{\"id\":\"${PRODUCT_UUID}\",\"current_release_download\":null}}" \
              || echo "Failed to clear current release download"
            
            # Wait a moment for the API to process
            sleep 2
            
            # Delete ALL downloads in the test product
            for download_id in "${ALL_DOWNLOAD_IDS[@]}"; do
              if [ -n "$download_id" ]; then
                echo "Deleting download: $download_id"
                DELETE_RESPONSE=$(curl --silent --write-out "HTTPSTATUS:%{http_code}" \
                  --request DELETE \
                  --url "https://api.surecart.com/v1/downloads/${download_id}" \
                  --header 'Accept: application/json' \
                  --header "Authorization: Bearer ${{ secrets.SURECART_API_TOKEN }}")
                
                HTTP_STATUS=$(echo "$DELETE_RESPONSE" | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
                
                if [ "$HTTP_STATUS" -eq 200 ]; then
                  echo "âœ… Successfully deleted download: $download_id"
                else
                  echo "âŒ Failed to delete download $download_id (HTTP $HTTP_STATUS)"
                fi
              fi
            done
          else
            echo "No downloads found in test product - already clean"
          fi
          
          echo "âœ… Product cleanup completed"

      - name: Test with Current Release Setting
        if: inputs.test_scenario == 'with_current_release' || inputs.test_scenario == null
        uses: ./
        with:
          media_uuid: '8cc4a4e0-102b-4266-a81e-4aef9ff5713c'
          product_uuids: 'c995fb9c-70cc-4de2-b34f-6ce9d331705a'
          set_as_current_release: 'true'
          surecart_api_token: ${{ secrets.SURECART_API_TOKEN }}

      - name: Test Multiple Products
        if: inputs.test_scenario == 'multiple_products'
        uses: ./
        with:
          media_uuid: '8cc4a4e0-102b-4266-a81e-4aef9ff5713c'
          product_uuids: 'c995fb9c-70cc-4de2-b34f-6ce9d331705a, c995fb9c-70cc-4de2-b34f-6ce9d331705a'
          set_as_current_release: 'false'
          surecart_api_token: ${{ secrets.SURECART_API_TOKEN }}

      - name: Test Error Handling (Invalid Media UUID)
        if: inputs.test_scenario == 'error_handling'
        uses: ./
        id: error-test
        continue-on-error: true
        with:
          media_uuid: 'invalid-uuid-12345'
          product_uuids: 'c995fb9c-70cc-4de2-b34f-6ce9d331705a'
          set_as_current_release: 'false'
          surecart_api_token: ${{ secrets.SURECART_API_TOKEN }}

      - name: Verify Error Test Failed as Expected
        if: inputs.test_scenario == 'error_handling'
        run: |
          if [ "${{ steps.error-test.outcome }}" != "failure" ]; then
            echo "::error::Expected the error test to fail, but it succeeded"
            exit 1
          else
            echo "âœ… Error handling test failed as expected"
          fi

  post-test-cleanup:
    name: Post-Test Information
    runs-on: ubuntu-latest
    needs: integration-test
    if: always()
    steps:
      - name: Integration Test Results
        run: |
          echo "## Integration Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Test Scenario:** ${{ inputs.test_scenario || 'basic (auto)' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ needs.integration-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.integration-test.result }}" == "success" ]; then
            echo "âœ… Integration test passed successfully!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Integration test failed. Check the logs above for details." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** These tests use real API calls to SureCart." >> $GITHUB_STEP_SUMMARY
